include:
  - https://gitlab.com/jitesoft/gitlab-ci-lib/raw/master/container_scan-v2.yml

variables:
  PLATFORMS: "linux/amd64,linux/arm64"

stages:
  - build
  - scan

build:
  stage: build
  image: registry.gitlab.com/jitesoft/dockerfiles/misc:latest
  script:
    - TAG_LIST=$(helper "jitesoft/cfssl,${CI_REGISTRY_IMAGE}", "latest")
    - docker buildx build --platform ${PLATFORMS} --progress plain --push ${TAG_LIST} .
    - docker pull ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
    - docker tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} quay.io/jitesoft/cfssl:latest
    - docker push quay.io/jitesoft/cfssl:latest
  tags:
    - arm64
    - amd64
    - jitesoft

scan:
  extends: .container_scanning
  variables:
    SCANNING_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:latest"
